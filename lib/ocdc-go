#!/usr/bin/env bash
#
# ocdc-go - Navigate to an existing devcontainer clone
#
# Usage:
#   ocdc go                         # List available clones for current repo
#   ocdc go <branch>                # Go to specific branch clone
#   ocdc go --repo <repo> <branch>  # Specify repo for disambiguation
#   ocdc go --vscode <branch>       # Open in VS Code instead of printing cd
#
# Options:
#   --repo, -r <repo>      Specify repository (for disambiguation)
#   --vscode, -v           Open in VS Code instead of printing cd command
#
# Examples:
#   ocdc go feature-x               # Print: cd ~/.cache/devcontainer-clones/myapp/feature-x
#   ocdc go --repo myapp main       # Go to myapp's main branch clone
#   ocdc go --vscode feature-x      # Opens VS Code in that directory
#   eval $(ocdc go feature-x)       # Actually cd to the directory
#
# In VS Code terminal, automatically opens VS Code window.
# In other terminals, prints the cd command (pipe to eval to execute).
#
# Related commands:
#   ocdc up     - Start devcontainer (creates clone if needed)
#   ocdc list   - List active instances
#   ocdc down   - Stop container
#   ocdc exec   - Execute command in container

set -euo pipefail

# Source paths library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../lib/ocdc-paths.bash"

CACHE_DIR="$OCDC_CACHE_DIR"
PORTS_FILE="$OCDC_PORTS_FILE"
CLONES_DIR="$OCDC_CLONES_DIR"

log() { echo "[ocdc-go] $*" >&2; }
error() { echo "[ocdc-go] ERROR: $*" >&2; exit 1; }

# Parse arguments
BRANCH=""
REPO=""
FORCE_VSCODE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo|-r)
      REPO="$2"
      shift 2
      ;;
    --vscode|-v)
      FORCE_VSCODE=true
      shift
      ;;
    --help|-h)
      sed -n '2,/^$/p' "$0" | sed 's/^# //' | sed 's/^#//'
      exit 0
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      BRANCH="$1"
      shift
      ;;
  esac
done

# Detect if running in VS Code integrated terminal
is_vscode_terminal() {
  [[ -n "${TERM_PROGRAM:-}" ]] && [[ "$TERM_PROGRAM" == "vscode" ]]
}

# Get current repo name
get_current_repo() {
  if git rev-parse --git-dir >/dev/null 2>&1; then
    basename "$(git rev-parse --show-toplevel)"
  else
    echo ""
  fi
}

# List all clones for a repo
list_clones() {
  local repo="$1"
  local repo_dir="${CLONES_DIR}/${repo}"
  
  if [[ -d "$repo_dir" ]]; then
    for branch_dir in "$repo_dir"/*/; do
      [[ -d "$branch_dir" ]] || continue
      local branch=$(basename "$branch_dir")
      local port=$(jq -r --arg ws "${branch_dir%/}" '.[$ws].port // "-"' "$PORTS_FILE" 2>/dev/null || echo "-")
      echo "$branch $port"
    done
  fi
}

# If no branch specified, list available and maybe select
if [[ -z "$BRANCH" ]]; then
  # Use --repo if provided, otherwise get from current directory
  if [[ -n "$REPO" ]]; then
    CURRENT_REPO="$REPO"
  else
    CURRENT_REPO=$(get_current_repo)
  fi
  
  if [[ -z "$CURRENT_REPO" ]]; then
    error "Not in a git repository. Specify a branch or use --repo."
  fi
  
  log "Available clones for $CURRENT_REPO:"
  echo ""
  
  clones=$(list_clones "$CURRENT_REPO")
  if [[ -z "$clones" ]]; then
    log "No clones found. Create one with: ocdc up <branch>"
    exit 0
  fi
  
  printf "  %-20s %s\n" "BRANCH" "PORT"
  printf "  %-20s %s\n" "------" "----"
  echo "$clones" | while read -r branch port; do
    printf "  %-20s %s\n" "$branch" "$port"
  done
  
  echo ""
  log "Usage: ocdc go <branch>"
  exit 0
fi

# Find the clone path
# Priority: --repo flag > tracked workspace resolution > current repo > search all repos

WORKSPACE=""

if [[ -n "$REPO" ]]; then
  # Explicit repo specified
  WORKSPACE="${CLONES_DIR}/${REPO}/${BRANCH}"
else
  # Try to resolve via ports.json (uses shared resolution with warnings)
  # Note: warnings go to stderr and should flow through to user
  if resolved_ws=$(ocdc_resolve_identifier "$BRANCH" ""); then
    # Successfully resolved - use it if the directory exists
    if [[ -d "$resolved_ws" ]]; then
      WORKSPACE="$resolved_ws"
    fi
  fi
  
  # Fall back to current repo if not resolved
  if [[ -z "$WORKSPACE" ]]; then
    CURRENT_REPO=$(get_current_repo)
    if [[ -n "$CURRENT_REPO" ]] && [[ -d "${CLONES_DIR}/${CURRENT_REPO}/${BRANCH}" ]]; then
      WORKSPACE="${CLONES_DIR}/${CURRENT_REPO}/${BRANCH}"
    fi
  fi
  
  # Last resort: search all repos
  if [[ -z "$WORKSPACE" ]]; then
    for repo_dir in "$CLONES_DIR"/*/; do
      [[ -d "$repo_dir" ]] || continue
      if [[ -d "${repo_dir}${BRANCH}" ]]; then
        WORKSPACE="${repo_dir}${BRANCH}"
        break
      fi
    done
  fi
fi

if [[ -z "$WORKSPACE" ]] || [[ ! -d "$WORKSPACE" ]]; then
  if [[ -n "$REPO" ]]; then
    error "Clone not found for '$REPO/$BRANCH'. Create it with: ocdc up --repo $REPO $BRANCH"
  else
    error "Clone not found for branch '$BRANCH'. Create it with: ocdc up $BRANCH"
  fi
fi

# Navigate or open
if [[ "$FORCE_VSCODE" == "true" ]] || is_vscode_terminal; then
  log "Opening $WORKSPACE in VS Code..."
  code "$WORKSPACE"
else
  # Print cd command - user can eval it or copy/paste
  echo "cd $WORKSPACE"
fi
