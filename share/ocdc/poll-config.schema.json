{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/athal7/ocdc/poll-config.schema.json",
  "title": "OCDC Poll Configuration",
  "description": "Configuration schema for ocdc poll configs that automate devcontainer sessions with OpenCode",
  "type": "object",
  "required": ["id", "source_type", "repo_filters"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this poll configuration"
    },
    "enabled": {
      "type": "boolean",
      "default": true,
      "description": "Whether this poll is enabled"
    },
    "source_type": {
      "type": "string",
      "enum": ["linear_issue", "github_issue", "github_pr"],
      "description": "Source type determines fetch command defaults, item mappings, and prompt templates"
    },
    "fetch": {
      "type": "object",
      "description": "Fetch options (alternative to fetch_command). Options vary by source_type.",
      "properties": {
        "assignee": {
          "type": "string",
          "description": "Filter by assignee. Use @me for current user. (linear_issue, github_issue)"
        },
        "review_requested": {
          "type": "string",
          "description": "Filter by review requested. Use @me for current user. (github_pr)"
        },
        "state": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ],
          "description": "Filter by state. String for GitHub (open/closed), array for Linear (started/unstarted/etc)"
        },
        "labels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Filter to items with these labels (GitHub)"
        },
        "exclude_labels": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Exclude items with these labels (Linear)"
        },
        "repo": {
          "type": "string",
          "description": "Limit to specific repository (owner/repo format)"
        },
        "org": {
          "type": "string",
          "description": "Limit to specific organization"
        }
      }
    },
    "fetch_command": {
      "type": "string",
      "description": "Shell command that outputs a JSON array of items. Mutually exclusive with 'fetch'."
    },
    "repo_filters": {
      "type": "array",
      "description": "Rules for mapping items to local repositories. Most specific rule wins.",
      "items": {
        "type": "object",
        "required": ["repo_path"],
        "properties": {
          "team": {
            "type": "string",
            "description": "Linear team key to match (case-insensitive)"
          },
          "labels": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Labels to match - item must have ANY of these (case-insensitive)"
          },
          "repo": {
            "type": "string",
            "description": "GitHub repository to match (owner/repo format, case-insensitive)"
          },
          "org": {
            "type": "string",
            "description": "GitHub organization to match (case-insensitive)"
          },
          "project": {
            "type": "string",
            "description": "Project name to match (case-insensitive)"
          },
          "milestone": {
            "type": "string",
            "description": "Milestone name to match (case-insensitive)"
          },
          "repo_path": {
            "type": "string",
            "description": "Local filesystem path to repository (supports ~ expansion)"
          }
        }
      },
      "minItems": 1
    },
    "item_mapping": {
      "type": "object",
      "description": "Optional jq expressions to extract fields. Defaults provided per source_type.",
      "properties": {
        "key": {
          "type": "string",
          "description": "jq expression for unique item identifier"
        },
        "repo": {
          "type": "string",
          "description": "jq expression for repository identifier"
        },
        "repo_short": {
          "type": "string",
          "description": "jq expression for short repository name"
        },
        "number": {
          "type": "string",
          "description": "jq expression for issue/PR number or identifier"
        },
        "title": {
          "type": "string",
          "description": "jq expression for item title"
        },
        "body": {
          "type": "string",
          "description": "jq expression for item body/description"
        },
        "url": {
          "type": "string",
          "description": "jq expression for item URL"
        },
        "branch": {
          "type": "string",
          "description": "jq expression for git branch name"
        }
      }
    },
    "prompt": {
      "type": "object",
      "description": "Optional prompt configuration. Defaults provided per source_type.",
      "oneOf": [
        {
          "properties": {
            "template": {
              "type": "string",
              "description": "Inline prompt template with {variable} placeholders"
            }
          },
          "additionalProperties": false
        },
        {
          "required": ["file"],
          "properties": {
            "file": {
              "type": "string",
              "description": "Path to prompt file (relative to config directory)"
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "session": {
      "type": "object",
      "description": "Optional session configuration. Defaults provided per source_type.",
      "properties": {
        "name_template": {
          "type": "string",
          "description": "Template for tmux session name with {variable} placeholders"
        },
        "agent": {
          "type": "string",
          "description": "OpenCode agent to use. Defaults: github_pr=plan, others=build"
        }
      }
    }
  },
  "not": {
    "required": ["fetch", "fetch_command"],
    "description": "fetch and fetch_command are mutually exclusive"
  },
  "examples": [
    {
      "id": "linear-assigned",
      "source_type": "linear_issue",
      "repo_filters": [
        { "team": "ENG", "repo_path": "~/code/engineering" }
      ]
    },
    {
      "id": "github-issues",
      "source_type": "github_issue",
      "repo_filters": [
        { "repo": "myorg/backend", "repo_path": "~/code/backend" }
      ]
    },
    {
      "id": "github-reviews",
      "source_type": "github_pr",
      "repo_filters": [
        { "org": "myorg", "repo_path": "~/code/myorg" }
      ]
    }
  ]
}
