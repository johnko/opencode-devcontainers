{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/athal7/ocdc/poll-config.schema.json",
  "title": "OCDC Poll Configuration",
  "description": "Configuration schema for ocdc poll configs that automate devcontainer sessions with OpenCode",
  "type": "object",
  "required": ["id", "fetch_command", "item_mapping", "prompt", "session"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this poll configuration"
    },
    "enabled": {
      "type": "boolean",
      "default": true,
      "description": "Whether this poll is enabled"
    },
    "source_type": {
      "type": "string",
      "default": "poll",
      "description": "Source type for tracking (used by opencode plugin). Examples: github_issue, github_pr, linear_issue"
    },
    "fetch_command": {
      "type": "string",
      "description": "Shell command that outputs a JSON array of items to process"
    },
    "item_mapping": {
      "type": "object",
      "description": "jq expressions to extract fields from each item in the fetch_command output",
      "required": ["key"],
      "properties": {
        "key": {
          "type": "string",
          "description": "jq expression for unique item identifier (used to track processed items)"
        },
        "repo": {
          "type": "string",
          "description": "jq expression for full repository name (e.g., 'owner/repo')"
        },
        "repo_short": {
          "type": "string",
          "description": "jq expression for short repository name"
        },
        "number": {
          "type": "string",
          "description": "jq expression for issue/PR number"
        },
        "title": {
          "type": "string",
          "description": "jq expression for item title"
        },
        "body": {
          "type": "string",
          "description": "jq expression for item body/description"
        },
        "url": {
          "type": "string",
          "description": "jq expression for item URL"
        },
        "branch": {
          "type": "string",
          "description": "jq expression for git branch name"
        }
      }
    },
    "repo_paths": {
      "type": "object",
      "description": "Map of repository names to local filesystem paths",
      "additionalProperties": {
        "type": "string",
        "description": "Local path to repository (supports ~ expansion)"
      }
    },
    "prompt": {
      "type": "object",
      "description": "Prompt configuration for OpenCode sessions",
      "oneOf": [
        {
          "required": ["template"],
          "properties": {
            "template": {
              "type": "string",
              "description": "Inline prompt template with {variable} placeholders"
            }
          }
        },
        {
          "required": ["file"],
          "properties": {
            "file": {
              "type": "string",
              "description": "Path to prompt file (relative to config directory)"
            }
          }
        }
      ]
    },
    "session": {
      "type": "object",
      "description": "OpenCode session configuration",
      "required": ["name_template"],
      "properties": {
        "name_template": {
          "type": "string",
          "description": "Template for tmux session name with {variable} placeholders"
        },
        "agent": {
          "type": "string",
          "default": "plan",
          "description": "OpenCode agent to use for the session. Defaults to 'plan' for safety in automated sessions. Other options: 'build', 'architect', or custom agents."
        }
      }
    }
  },
  "examples": [
    {
      "id": "github-issues",
      "enabled": true,
      "source_type": "github_issue",
      "fetch_command": "gh issue list --repo OWNER/REPO --label \"ocdc:ready\" --state open --json number,title,body,url | jq '[.[] | . + {repo: \"OWNER/REPO\", repo_short: \"REPO\"}]'",
      "item_mapping": {
        "key": "\"\\(.repo)-issue-\\(.number)\"",
        "repo": ".repo",
        "repo_short": ".repo_short",
        "number": ".number",
        "title": ".title",
        "body": ".body",
        "url": ".url",
        "branch": "\"issue-\\(.number)\""
      },
      "repo_paths": {
        "OWNER/REPO": "~/path/to/repo"
      },
      "prompt": {
        "template": "Work on issue #{number}: {title}\n{url}\n\n{body}"
      },
      "session": {
        "name_template": "ocdc-{repo_short}-issue-{number}"
      }
    }
  ]
}
