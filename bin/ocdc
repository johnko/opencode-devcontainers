#!/usr/bin/env bash
#
# ocdc - OpenCode DevContainers
#
# Unified CLI for managing devcontainer instances with auto-assigned ports
# and branch-based isolation.
#
# Usage:
#   ocdc                    # Launch TUI
#   ocdc <command> [args]   # Run subcommand
#
# Commands:
#   up [branch]             Start a devcontainer
#   down [workspace]        Stop a devcontainer
#   exec <cmd>              Execute command in container
#   list                    List instances
#   go [branch]             Navigate to clone
#   clean                   Clean up orphaned clones
#   version                 Show version
#   help                    Show this help
#
# For command-specific help:
#   ocdc <command> --help

set -euo pipefail

VERSION="2.5.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# Source paths library for OCDC_* variables
source "${LIB_DIR}/ocdc-paths.bash" 2>/dev/null || true

# Plugin paths
PLUGIN_SOURCE="${SCRIPT_DIR}/../plugin"
OPENCODE_PLUGINS_DIR="${HOME}/.config/opencode/plugins"
PLUGIN_DEST="${OPENCODE_PLUGINS_DIR}/ocdc"

# Show version
show_version() {
  cat << 'EOF'
      ⚡
  ___  ___ ___  ___ 
 / _ \/ __/ _ \/ __|
| (_) | (_| (_) | (__ 
 \___/ \___\___/ \___|
      ⚡
EOF
  echo "  ocdc v$VERSION"
}

# Show help
show_help() {
  cat << 'EOF'
Usage: ocdc [command] [options]

OpenCode DevContainers - Run multiple devcontainer instances with auto-assigned
ports and branch-based isolation.

Commands:
  up [branch]        Start a devcontainer (creates clone for branch)
  down [workspace]   Stop a devcontainer
  exec <cmd>         Execute command in running container
  list               List all instances and clones
  go [branch]        Navigate to an existing clone
  clean              Clean up orphaned clones
  poll [options]     Poll sources and spawn OpenCode sessions
  plugin <cmd>       Manage OpenCode plugin (install/status/uninstall)
  version            Show version information
  help               Show this help message

Options:
  --help, -h         Show help for command
  --version, -v      Show version

Examples:
  ocdc                      # Launch interactive TUI
  ocdc up                   # Start devcontainer for current directory
  ocdc up feature-x         # Create clone for branch, start devcontainer
  ocdc down                 # Stop current container
  ocdc exec npm test        # Run tests in container
  ocdc list                 # Show all instances
  ocdc go feature-x         # Navigate to existing clone

For more information, see: https://github.com/athal7/ocdc
EOF
}

# Plugin management
plugin_install() {
  echo "Installing ocdc OpenCode plugin..."
  
  if [[ ! -d "$PLUGIN_SOURCE" ]]; then
    echo "Error: Plugin source not found at $PLUGIN_SOURCE" >&2
    exit 1
  fi
  
  mkdir -p "$PLUGIN_DEST/command"
  cp "$PLUGIN_SOURCE/index.js" "$PLUGIN_DEST/"
  cp "$PLUGIN_SOURCE/helpers.js" "$PLUGIN_DEST/"
  cp "$PLUGIN_SOURCE/command/ocdc.md" "$PLUGIN_DEST/command/"
  
  # Remove old command file if exists
  rm -f "$PLUGIN_DEST/command/ocdc-use.md"
  
  echo "Plugin installed to: $PLUGIN_DEST"
  echo ""
  echo "Add to your ~/.config/opencode/opencode.json plugin array:"
  echo '  "plugin": ["~/.config/opencode/plugins/ocdc"]'
}

plugin_status() {
  echo "ocdc OpenCode Plugin Status"
  echo "===========================" 
  echo ""
  
  if [[ -d "$PLUGIN_DEST" ]]; then
    echo "Installed: Yes"
    echo "Location:  $PLUGIN_DEST"
    echo ""
    echo "Files:"
    ls -la "$PLUGIN_DEST" 2>/dev/null | tail -n +2
  else
    echo "Installed: No"
    echo ""
    echo "Run 'ocdc plugin install' to install."
  fi
}

plugin_uninstall() {
  if [[ -d "$PLUGIN_DEST" ]]; then
    rm -rf "$PLUGIN_DEST"
    echo "Plugin uninstalled from: $PLUGIN_DEST"
  else
    echo "Plugin not installed."
  fi
}

plugin_cmd() {
  local subcmd="${1:-status}"
  
  case "$subcmd" in
    install)
      plugin_install
      ;;
    status)
      plugin_status
      ;;
    uninstall)
      plugin_uninstall
      ;;
    --help|-h)
      echo "Usage: ocdc plugin <command>"
      echo ""
      echo "Commands:"
      echo "  install    Install/update plugin to ~/.config/opencode/plugins/"
      echo "  status     Show plugin installation status"
      echo "  uninstall  Remove plugin"
      ;;
    *)
      echo "Unknown plugin command: $subcmd" >&2
      echo "Run 'ocdc plugin --help' for usage." >&2
      exit 1
      ;;
  esac
}

# Dispatch to subcommand
dispatch() {
  local cmd="$1"
  shift
  
  case "$cmd" in
    up)
      exec "$LIB_DIR/ocdc-up" "$@"
      ;;
    down)
      exec "$LIB_DIR/ocdc-down" "$@"
      ;;
    exec)
      exec "$LIB_DIR/ocdc-exec" "$@"
      ;;
    list)
      exec "$LIB_DIR/ocdc-list" "$@"
      ;;
    go)
      exec "$LIB_DIR/ocdc-go" "$@"
      ;;
    clean)
      exec "$LIB_DIR/ocdc-clean" "$@"
      ;;
    tui)
      exec "$LIB_DIR/ocdc-tui" "$@"
      ;;
    poll)
      exec "$LIB_DIR/ocdc-poll" "$@"
      ;;
    plugin)
      plugin_cmd "$@"
      ;;
    version|--version|-v)
      show_version
      ;;
    help|--help|-h)
      show_help
      ;;
    *)
      echo "Unknown command: $cmd" >&2
      echo "" >&2
      echo "Run 'ocdc help' for usage." >&2
      exit 1
      ;;
  esac
}

# Main
main() {
  # No arguments - launch TUI or show help
  if [[ $# -eq 0 ]]; then
    # If stdin is a terminal, launch TUI
    if [[ -t 0 ]] && [[ -t 1 ]]; then
      exec "$LIB_DIR/ocdc-tui"
    else
      # Non-interactive - show help
      show_help
    fi
    return
  fi
  
  dispatch "$@"
}

main "$@"
