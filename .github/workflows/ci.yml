name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          sudo npm install -g @devcontainers/cli

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install opencode
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Setup opencode plugin
        run: |
          mkdir -p ~/.config/opencode/plugins/ocdc/command
          cp plugin/index.js plugin/helpers.js ~/.config/opencode/plugins/ocdc/
          cp plugin/command/ocdc.md ~/.config/opencode/plugins/ocdc/command/
          mkdir -p ~/.config/opencode
          cat > ~/.config/opencode/opencode.json << 'EOF'
          {
            "model": "opencode/gpt-5-nano",
            "plugin": ["/home/runner/.config/opencode/plugins/ocdc"]
          }
          EOF

      - name: Run tests
        run: ./test/run_tests.bash

  release:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Run semantic-release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.HOMEBREW_APP_ID }}
          private-key: ${{ secrets.HOMEBREW_APP_PRIVATE_KEY }}
          owner: athal7
          repositories: homebrew-tap

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: ocdc
          homebrew-tap: athal7/homebrew-tap
          tag-name: v${{ needs.release.outputs.new_release_version }}
          push-to: athal7/homebrew-tap
          base-branch: main
          create-pullrequest: false
          create-branch: false
          commit-message: |
            chore: bump {{formulaName}} to {{version}}
        env:
          COMMITTER_TOKEN: ${{ steps.app-token.outputs.token }}
